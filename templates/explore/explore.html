{% extends "base.html" %}

{% block content %}

<style>

    #explore-container {
        height:100vh;
        overflow: hidden;
    }

    #property-card-container {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        padding: 8px 4px;
        position: relative;
        height: 100%;
        overflow: hidden;
    }

    #property-card-container a {
        text-decoration: none;
        color: var(--foreground);
    }

    #map-container {
        position: absolute;
        transition: none;
        transform: translateX(100%);
        z-index: 1000;
    }
    #map-container[data-visible="true"] {
        transform: translateX(0%);
        transition: transform 300ms ease;
    }
    #map-container[data-visible="false"] {
        transform: translateX(100%);
        transition: transform 300ms ease;
    }

    @media only screen and (min-width: 1000px) {
        #explore-container {
            height: 95vh;
        }
        #map-container {
            position: relative;
            transform: translateX(0%)!important;
            display: block;
        }
        #map-button {
            display: none; 
        }
    }

</style>
    
<div id='explore-container' class="d-flex flex-column align-items-center position-relative" >

    <div id='current-search' class="d-flex w-100 pt-3 pb-2 px-2 m-0 mb-1" style="background-color: var(--bs-dark-bg-subtle)">
        <div class="d-flex col-lg-4">
            <input id="location-search" type="text" class="form-control me-2" style="border:3px solid var(--bs-secondary-color);" placeholder="{{ search_str }}" >
            <button id="search-button" class="btn btn-sm love-outline border-3 me-2">Search</button>
            <button class="btn btn-sm btn-outline-info border-3" data-bs-toggle="offcanvas" data-bs-target="#offcanvasBottom">
                {% include "icons/filter.html" %}
            </button>
        </div>
    </div>

    <div class="d-flex justify-content-center w-100 h-100">

        <div id='swiping-component' class="col-12 col-md-8 col-lg-4 overflow-hidden p-1 px-2">

            <div class="d-flex align-items-center justify-content-between px-3 pt-1 pb-2">
                <h3 class="mb-0">Explore</h3>
                <button 
                id="map-button" 
                class="btn border-0 p-0 m-0" 
                onclick="toggleMapView()"
                >
                    {% include "icons/map-icon.html" %}
                </button>
            </div>

            <!-- Swiping Property List -->
            <div id='property-card-container'>

                {% if not property_list %}

                    {% include "explore/partials/end-of-list.html" %}

                {% else %}

                    {% for property in property_list %}

                        {% include "explore/partials/property-card.html" %}

                    {% endfor %}
                    
                {% endif %}

                 <!-- Controls -->
                {% comment %} {% if property_obj %}
                    {% include "explore/partials/explore-controls.html" %}
                {% endif %} {% endcomment %}

            </div>

        </div>

        <div id='map-container' class="col-12 col-lg-8 p-1 h-100" style="background-color: var(--bs-body-bg);" data-visible="false">
            <div id="map-header" class="d-flex align-items-center justify-content-between px-3 pt-1 pb-2">
                <h3 class="mb-0">Map</h3>
                <button 
                id="map-button" 
                class="btn border-0 p-0 m-0" 
                onclick="toggleMapView()"
                >
                    {% include "icons/arrows.html" %}
                </button>
            </div>
            
            {% include "explore/partials/explore-map.html" %}
        
        </div>
    
    </div>

</div>

{% include "explore/partials/explore-filter2.html" %}

{% include "components/register-modal.html" %}


<script>

    let activeIndex = 0;
    const cards = document.getElementsByClassName("property-card");

    const setImageAtIndex = (index) => {
        if (index === 0) {
            return
        }
        const cardAtIndex = document.querySelector(`[data-index="${index}"]`);
        if (cardAtIndex.dataset.imgdidset === "true") {
            return
        }
        const address = document.getElementById(`property-address-${cardAtIndex.id}`).innerText.replace('/','|');
        htmx.ajax('GET', `/explore/get-card-image/`, { target:`#property-card-image-${ cardAtIndex.id }`, swap:'outerHTML', values: { address: address, property_id: cardAtIndex.id } })
        cardAtIndex.dataset.imgdidset = "true";
    }

    const setPreciseCardIndex = (index) => {
        const currentCard = document.querySelector(`[data-index="${activeIndex}"]`);
        let nextIndex = index;
        const nextCard = document.querySelector(`[data-index="${nextIndex}"]`);
        currentCard.dataset.status = "left";
        nextCard.dataset.status = "becoming-active-from-right";
        setImageAtIndex(nextIndex);
        setTimeout(() => {
            nextCard.dataset.status = "active";
            activeIndex = nextIndex;
        }, 100);  

        document.getElementById(`marker-div-${currentCard.id}`).dataset.focused = "false";
        document.getElementById(`marker-div-${nextCard.id}`).dataset.focused = "true";

        setTimeout(() => {
            document.getElementById("map-container").dataset.visible = "false" ;
        }, 800);

        setImageAtIndex(nextIndex + 1);
        setImageAtIndex(nextIndex - 1);
    }

    const handleNextCard = () => {
        const currentCard = document.querySelector(`[data-index="${activeIndex}"]`);
        let nextIndex = activeIndex + 1 <= cards.length - 1 ? activeIndex + 1 : 0;
        const nextCard = document.querySelector(`[data-index="${nextIndex}"]`);
        currentCard.dataset.status = "left";
        nextCard.dataset.status = "becoming-active-from-right";
        setTimeout(() => {
            nextCard.dataset.status = "active";
            activeIndex = nextIndex;
        }, 100);  
        document.getElementById(`marker-div-${currentCard.id}`).dataset.focused = "false";
        document.getElementById(`marker-div-${nextCard.id}`).dataset.focused = "true";

        setImageAtIndex(nextIndex + 1);
    }

    const handlePrevCard = () => {
        const currentCard = document.querySelector(`[data-index="${activeIndex}"]`);
        let nextIndex = activeIndex - 1 >= 0 ? activeIndex - 1 : cards.length - 1;
        const nextCard = document.querySelector(`[data-index="${nextIndex}"]`);
        currentCard.dataset.status = "right";
        nextCard.dataset.status = "becoming-active-from-left";
        setTimeout(() => {
            nextCard.dataset.status = "active";
            activeIndex = nextIndex;
        }, 100);  
        document.getElementById(`marker-div-${currentCard.id}`).dataset.focused = "false";
        document.getElementById(`marker-div-${nextCard.id}`).dataset.focused = "true";

        setImageAtIndex(nextIndex - 1);
    }

    const handleSaveCard = () => {
        const currentCard = document.querySelector(`[data-index="${activeIndex}"]`);
        currentCard.classList.toggle("saved")
        currentCard.classList.toggle("bounce2")
        let imageStr = document.getElementById(`property-card-image-${currentCard.id}`).src;
        let addressStr = document.getElementById(`property-address-${currentCard.id}`).innerText;
        htmx.ajax('POST', `/explore/explore-toggle-saved/${currentCard.id}/`, {target:`#save-button-${currentCard.id}`, swap:'outerHTML', values: { address: addressStr, image: imageStr } })
    }

    const handleHideCard = async () => {
        // get current card
        const currentCard = document.querySelector(`[data-index="${activeIndex}"]`);
        // set status to hidden -> hidden css transition
        currentCard.dataset.status = "hidden";
        // remove card from DOM following transition
        await new Promise(resolve => setTimeout(resolve, 300));
        currentCard.remove();
        // update index of remaining cards
        for (let i = 0; i < cards.length; i++) {
            cards[i].dataset.index = i;
        } 
        // if no cards left, retrieve new cards
        if (cards.length === 0) {
            console.log('retrieve new cards')
            // htmx.ajax('GET', `/property/get-explore-controls/${nextCard.id}/`, {target:'#explore-controls', swap:'outerHTML'})
            return
        }
        // increment index
        let nextIndex = activeIndex <= cards.length - 1 ? activeIndex : 0;
        // get and display next card
        const nextCard = document.querySelector(`[data-index="${nextIndex}"]`);
        nextCard.dataset.status = "becoming-active-from-right";
        setTimeout(() => {
            nextCard.dataset.status = "active";
            activeIndex = nextIndex;
        }, 100);   
        
        document.getElementById(`marker-div-${currentCard.id}`).dataset.focused = "false";
        document.getElementById(`marker-div-${nextCard.id}`).dataset.focused = "true";

        setImageAtIndex(nextIndex + 1);
    }

    function showFilterPopover() {
        const filterPopover = document.getElementById("explore-filter-popover");
        filterPopover.style.display = "flex";
        setTimeout(() => {
            filterPopover.classList.toggle("popover-hidden");
        }, 10);  
    }

    function toggleMapView() {
        const mapContainer = document.getElementById("map-container");
        // const swipingComponent = document.getElementById("swiping-component");
        mapContainer.dataset.visible = mapContainer.dataset.visible === "false" ? "true" : "false";
        // swipingComponent.style.display = swipingComponent.style.display === "none" ? "block" : "none";
    }

    function submitSearch(event) {
        event.preventDefault();
        const search = document.getElementById('location-search').value;
        if (search === '') {
          return;
        }
        window.location.replace(`/explore/search=${search}`)
      }
    
      const searchButton = document.getElementById('search-button');
      searchButton.addEventListener("click", submitSearch, false);
    
      function initialize() {
        new google.maps.places.Autocomplete(searchInput);
      }
      const searchInput = document.getElementById('location-search');
      searchInput.addEventListener('keypress', initialize);

</script>

<!-- {{ map_data|json_script:"map_data" }}
{{ property_list|json_script:"property_list" }}

<script id="explore-map-script" data-loc-cookie="{{ request.COOKIES.coordinates }}">


    function buildMap() {
        var container = L.DomUtil.get('map');
        if(container != null){
            container._leaflet_id = null;
        }
        // Get the map data from the django context
        let coordinates = null;
        let boundry = null;
        let zoom = 16;
        const map_data = JSON.parse(document.getElementById('map_data').textContent);
        if (map_data) {
            coordinates = map_data.coordinates;
            boundry = map_data.boundry;
            zoom = map_data.zoom;
        }

        // Initialize Map Global View 
        var map = L.map('map').fitWorld();
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        function onLocationFound(e) {
            var radius = e.accuracy;
            L.marker(e.latlng).addTo(map)
            L.circle(e.latlng, radius).addTo(map);
            htmx.ajax('GET', '/accounts/locate/', {values: e.latlng, swap:'none'})
            window.location.replace(`/explore/reverse/lng=${e.latlng.lng}lat=${e.latlng.lat}/`)
        }
        map.on('locationfound', onLocationFound);

        function onLocationError(e) {
        // no location provided, redirect to default location
        window.location.href = '/explore/search%3DPensacola, FL, USA/';
        }
        // if coordinates or user location not provided and boundry  not provided, set the map view to the default location
        map.on('locationerror', onLocationError);     

        // get coordinates from django context
        if (coordinates) { // if coordinates are provided, set the map view to the coordinates
            map.setView(coordinates, zoom);
            // var marker = L.marker(coordinates).addTo(map);
        } else { // if no coordinates are provided, set the map view to the user's location
            var cookieCoordinates = document.currentScript.getAttribute('data-loc-cookie')
            if (cookieCoordinates !== '') {
                var parsedCookie = JSON.parse(cookieCoordinates);
                // window.location.replace(`/explore/reverse/lng=${parsedCookie.lng}lat=${parsedCookie.lat}/`)
                // map.setView(parsedCookie, zoom);
                // L.marker(parsedCookie).addTo(map)
            } else {
                map.locate({setView: true, maxZoom: zoom});
            }
        }

        if (boundry) {
            L.polygon(boundry).addTo(map);
        } 

        // Get the property list from the django context
        function renderMapPoints(propertyList) {
            propertyList.forEach(function (property, index) {
                let priceFormatted = property.price.value.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })
                L.marker([property.latLong.value.latitude, property.latLong.value.longitude], 
                    {
                        icon: L.divIcon({
                            className: 'markerDiv', 
                            html: `<span id="marker-div-${property.propertyId}" data-index="${index}" data-focused="false" class="map-marker">${priceFormatted}</span>`
                        })
                    }
                )
                .on('click', function (e) {
                    setPreciseCardIndex(index);
                })
                .addTo(map)

                L.circleMarker([property.latLong.value.latitude, property.latLong.value.longitude],
                    {
                        color: 'white',
                        fillColor: 'var(--love)',
                        fillOpacity: 1,

                    }
                )
                .setRadius(8)
                .on('click', function (e) {
                    map.setView(e.latlng, 13); 
                    setPreciseCardIndex(index);
                })
                .addTo(map)
            });
        }

        let propertyList = JSON.parse(document.getElementById('property_list').textContent);
        renderMapPoints(propertyList);

        map.on('zoomend', function (e) {
            if (e.target._zoom >= 13) {
                displayCustomMarkerDiv()
            } else {
                hideCustomMarkerDiv()
            }
        });

    }
    buildMap();

    function displayCustomMarkerDiv() {
        document.querySelectorAll('.markerDiv').forEach(function (marker) {
            marker.setAttribute('data-visible', 'true')
        })
        document.querySelectorAll('.map-marker').forEach(function (marker) {
            marker.setAttribute('data-visible', 'true')
        })
        document.querySelectorAll('.leaflet-zoom-animated g').forEach(function (marker) {
            marker.setAttribute('data-visible', 'false')
        })
    }

    function hideCustomMarkerDiv() {
        document.querySelectorAll('.markerDiv').forEach(function (marker) {
            marker.setAttribute('data-visible', 'false')
        })
        document.querySelectorAll('.map-marker').forEach(function (marker) {
            marker.setAttribute('data-visible', 'false')
        })
        document.querySelectorAll('.leaflet-zoom-animated g').forEach(function (marker) {
            marker.setAttribute('data-visible', 'true')
        })
    }

    // function rerenderMapPoints() {
    //     console.log('rerender map')
        
    //     map.eachLayer(function (layer) {
    //         if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
    //             map.removeLayer(layer);
    //         }
    //     });
    //     let propertyList = JSON.parse(document.getElementById('property_list_map').textContent);
    //     renderMapPoints(propertyList);
    // } 
    
</script> -->

{% if request.htmx %}
    {% include "explore/partials/map-container.html" with property_list=property_list%}
{% endif %}

{% endblock content %}